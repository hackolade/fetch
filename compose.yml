services:

  server: 
    build:
      context: .
      dockerfile: Dockerfile
      target: hck-fetch-test-server
    init: true
    expose:
      - 3000
    networks:
      - internet
    healthcheck:
      test:
        [
          'CMD',
          'sh',
          '-exec',
          'curl -sSL --fail localhost:3000/status',
        ]
      interval: 2s
      timeout: 2s
      retries: 5
      start_period: 1s

  proxy:
    image: hackolade.azurecr.io/squid-proxy:latest
    init: true
    entrypoint: /apps/squid/sbin/squid
    command: --foreground
    expose:
      - 3128
    networks:
      - intranet
      - internet
    healthcheck:
      test:
        [
          'CMD',
          'sh',
          '-exec',
          'curl -sSL --fail -x localhost:3128 https://google.com',
        ]
      interval: 2s
      timeout: 2s
      retries: 5
      start_period: 1s

  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: hck-fetch-test-app
    init: true
    networks:
      - intranet
    environment:
      - HTTP_PROXY=proxy:3128
      - HTTPS_PROXY=proxy:3128
    depends_on:
      server:
        condition: service_healthy
      proxy:
        condition: service_healthy

  tests: 
    build:
      context: .
      dockerfile: Dockerfile
      target: hck-fetch-tests
    init: true
    networks:
      - internet
    depends_on:
      app:
        condition: service_completed_successfully

networks:
  intranet:
    name: hck-fetch-test-intranet
    internal: true
  internet:
    name: hck-fetch-test-internet
    driver: bridge
