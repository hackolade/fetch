configs:
  squid-basic-auth:
    file: ./test/resources/proxy/squid-basic-auth.conf

services:

  hck-fetch-test-proxy: &hck-fetch-test-proxy
    profiles: [test]
    image: hackolade.azurecr.io/squid-proxy:latest
    init: true
    entrypoint: /apps/squid/sbin/squid
    command: -N
    ports:
      - 3128:3128
    environment:
      - HEALTH_CHECK_PROXY_URL=localhost:3128
    healthcheck:
      test:
        [
          'CMD',
          'sh',
          '-exec',
          'curl -sSL --fail -x $${HEALTH_CHECK_PROXY_URL} https://hackolade.com',
        ]
      interval: 2s
      timeout: 2s
      retries: 5
      start_period: 1s

  hck-fetch-test-proxy-basic-auth:
    <<: *hck-fetch-test-proxy
    command: -N -f /etc/squid/squid.conf
    ports:
      - 3129:3128
    environment:
      - HEALTH_CHECK_PROXY_URL=http://user1:user1@localhost:3128
    configs:
      - source: squid-basic-auth
        target: /etc/squid/squid.conf

  hck-fetch-test-server:
    profiles: [test]
    build:
      context: .
      dockerfile: Dockerfile
      target: hck-fetch-test-server
    init: true
    ports:
      - 3000:3000
    healthcheck:
      test:
        [
          'CMD',
          'sh',
          '-exec',
          'curl -sSL --fail localhost:3000/status',
        ]
      interval: 2s
      timeout: 2s
      retries: 5
      start_period: 1s
    depends_on:
      hck-fetch-test-proxy:
        condition: service_healthy
      hck-fetch-test-proxy-basic-auth:
        condition: service_healthy

  hck-fetch-test-app: &hck-fetch-test-app
    profiles: [template]
    build:
      context: .
      dockerfile: Dockerfile
      target: hck-fetch-test-app
    init: true
    network_mode: host 
    healthcheck:
      test:
        [
          'CMD',
          'sh',
          '-exec',
          'curl -sSL --fail localhost:$${PORT}/status',
        ]
      interval: 2s
      timeout: 2s
      retries: 5
      start_period: 1s
    depends_on:
      hck-fetch-test-server:
        condition: service_healthy

  hck-fetch-test-app-direct:
    <<: *hck-fetch-test-app
    profiles: [test]
    environment:
      - PORT=3001
      - SERVER_API_URL=http://localhost:3000/initiators/direct

  hck-fetch-test-app-proxy:
    <<: *hck-fetch-test-app
    profiles: [test]
    environment:
      - PORT=3002
      - SERVER_API_URL=http://hck-fetch-test-server:3000/initiators/proxy
      - HTTP_PROXY=localhost:3128
      - HTTPS_PROXY=localhost:3128

  hck-fetch-test-app-proxy-basic-auth:
    <<: *hck-fetch-test-app
    profiles: [test]
    environment:
      - PORT=3003
      - SERVER_API_URL=http://hck-fetch-test-server:3000/initiators/proxy-basic-auth
      - HTTP_PROXY=localhost:3129
      - HTTPS_PROXY=localhost:3129
    
  hck-fetch-tests:
    profiles: [test]
    build:
      context: .
      dockerfile: Dockerfile
      target: hck-fetch-tests
    init: true
    network_mode: host
    tty: true
    depends_on:
      hck-fetch-test-app-direct:
        condition: service_healthy
      hck-fetch-test-app-proxy:
        condition: service_healthy
      hck-fetch-test-app-proxy-basic-auth:
        condition: service_healthy
